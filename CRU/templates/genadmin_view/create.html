{% extends base_template|default:'base_eb.html' %}
{% block title %}
<title>Create Article</title>
{% endblock title %}

{% block content %}
<main class="bg-gray-50 min-h-screen py-8 px-4 md:px-8">
  <div class="max-w-7xl mx-auto">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 md:mb-0">Create New Article</h2>
      <a href="{% url 'CRU:DashboardPending' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out text-sm font-medium flex items-center">
        <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Pending
      </a>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
      <form id="articleForm" method="post" class="space-y-6">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label for="title" class="block text-sm font-medium text-gray-700">Article Title</label>
            <input type="text" id="title" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" required>
          </div>

          <div class="space-y-2">
            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
            <div class="relative">
              <select id="category" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary appearance-none pr-10" required>
                <option value="" disabled selected>Select a category</option>
                <option value="1" data-class="category-universitynews">University News</option>
                <option value="2" data-class="category-editorial">Editorial</option>
                <option value="3" data-class="category-opinion">Opinion</option>
                <option value="4" data-class="category-inphotos">In Photos</option>
                <option value="5" data-class="category-satire">Satire</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
            <div id="categoryBadgePreview" class="mt-2 hidden">
              <span id="categoryBadge" class="">CATEGORY</span>
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label for="content" class="block text-sm font-medium text-gray-700">Content</label>
          <textarea id="content" name="content" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" rows="12"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label for="featureImage" class="block text-sm font-medium text-gray-700">Feature Image</label>
            <input type="file" id="featureImage" name="featureImage" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
            <div id="imagePreview" class="mt-4 hidden">
              <img id="previewImg" src="#" alt="Image preview" class="max-h-48 max-w-full rounded-md border border-gray-300">
            </div>
          </div>

          <div class="space-y-2">
            <label for="journalist" class="block text-sm font-medium text-gray-700">Photo Journalist</label>
            <input type="text" id="journalist" name="journalist" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
          </div>
        </div>

        <div class="flex justify-end pt-4">
          <button type="submit" id="submitArticle" class="bg-primary hover:bg-secondary text-white py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out font-medium">Submit Article</button>
        </div>
      </form>
    </div>
  </div>
</main>

<style>
  .category-universitynews {
    font-size: 10px;
    font-weight: 600;
    color: #fff;
    background-color: #0A2566;
    padding: 2px 6px;
    text-transform: uppercase;
  }
  
  .category-editorial {
    font-size: 10px;
    font-weight: 600;
    color: #fff;
    background-color: #D4B835;
    padding: 2px 6px;
    text-transform: uppercase;
  }
  
  .category-opinion {
    font-size: 10px;
    font-weight: 600;
    color: #fff;
    background-color: #8F181B;
    padding: 2px 6px;
    text-transform: uppercase;
  }
  
  .category-inphotos {
    font-size: 10px;
    font-weight: 600;
    color: #fff;
    background-color: #009C65;
    padding: 2px 6px;
    text-transform: uppercase;
  }
  
  .category-satire {
    font-size: 10px;
    font-weight: 600;
    color: #fff;
    background-color: #F88ED3;
    padding: 2px 6px;
    text-transform: uppercase;
  }
</style>

<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    ClassicEditor
      .create(document.querySelector('#content'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'outdent', 'indent', '|', 'blockQuote', 'insertTable', 'undo', 'redo'],
        link: {
          addTargetToExternalLinks: true,
          defaultProtocol: 'https://'
        }
      })
      .catch(error => {
        console.error(error);
      });
      
    document.getElementById('featureImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImg').src = e.target.result;
          document.getElementById('imagePreview').classList.remove('hidden');
        }
        reader.readAsDataURL(file);
      }
    });
    
    // Category badge preview
    const categorySelect = document.getElementById('category');
    const categoryBadge = document.getElementById('categoryBadge');
    const categoryBadgePreview = document.getElementById('categoryBadgePreview');
    
    categorySelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const categoryClass = selectedOption.getAttribute('data-class');
      const categoryText = selectedOption.text.toUpperCase();
      
      if (categoryClass) {
        categoryBadge.className = categoryClass;
        categoryBadge.textContent = categoryText;
        categoryBadgePreview.classList.remove('hidden');
      } else {
        categoryBadgePreview.classList.add('hidden');
      }
    });

    document.getElementById('articleForm').addEventListener('submit', function(event){
      event.preventDefault();
      
      const title = document.getElementById('title').value;
      const content = document.getElementById('content').value;
      const category = document.getElementById('category').value;
      const journalist = document.getElementById('journalist').value;
      
      const fileInput = document.getElementById('featureImage');
      let imageUrl = '';
      if (fileInput.files.length > 0) {
        imageUrl = document.getElementById('previewImg').src || '#';
      }
      
      const formData = {
        title: title,
        content: content,
        category: category,
        author: 1,
        image: imageUrl,
        journalist: journalist
      };

      fetch("{% url 'CRU:NewArticle' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(formData)
      })
      .then(res => {
        if (res.ok) {
          window.location.href = "{% url 'CRU:DashboardPending' %}";
        } else {
          alert('Error saving article');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the article');
      });
    });
  });
</script>
{% endblock %}